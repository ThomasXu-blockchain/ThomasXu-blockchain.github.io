<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="baidu-site-verification" content="093lY4ziMu" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="Thomas_Xu&#39;s Bolg">
    <meta name="keyword"  content="Thomas_Xu, BlockChain">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!--<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>-->
    <title>
        
          Compound系列（3） - Thomas_Xu
        
    </title>

    <link rel="canonical" href="https://thomasxu-blockchain.github.io/Compound-more/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="../css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
        
<link rel="stylesheet" href="../css/dusign-light.css">

        
<link rel="stylesheet" href="../css/dusign-common-light.css">

        
<link rel="stylesheet" href="../css/font-awesome.css">

        
<link rel="stylesheet" href="../css/toc.css">

        <!-- background effects end -->
    
    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="../css/highlight.css">


    
<link rel="stylesheet" href="../css/widget.css">


    
<link rel="stylesheet" href="../css/rocket.css">


    
<link rel="stylesheet" href="../css/signature.css">


    
<link rel="stylesheet" href="../css/fonts.googleapis.css">


    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- photography -->
    
<link rel="stylesheet" href="../css/photography.css">


    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- background effects start -->
    
    <!-- background effects end -->

	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            
                background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('Iron-Man-3.jpg')
                /*post*/
            
        
    }
    
    #signature{
        background-image: url('/img/signature/dusign.png');
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Coumpound" title="Coumpound">Coumpound</a>
                            
                        </div>
                        <h1>Compound系列（3）</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Thomas_Xu on
                            2022-12-09
                        </span>

                        

                    </div>
                

                </div>
            </div>
        </div>      
    </div>

    
    <div class="waveWrapper">
        <div class="wave wave_before" style="background-image: url('/img/wave-light.png')"></div>
        <div class="wave wave_after" style="background-image: url('/img/wave-light.png')"></div>
    </div>
    
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Thomas_Xu&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/categories/">Categories</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <hr>
<pre><code>author：Thomas_Xu
</code></pre><h1 id="Compound系列（3）-More"><a href="#Compound系列（3）-More" class="headerlink" title="Compound系列（3） More"></a>Compound系列（3） More</h1><h2 id="杠杆交易"><a href="#杠杆交易" class="headerlink" title="杠杆交易"></a>杠杆交易</h2><p>目前，借贷市场的强需求之一就是为了杠杆交易。但是，将 A 资产抵押到 Compound 再借出 B 资产，之后再到 DEX 平台（如 Uniswap）用 B 资产兑换成 A 资产，又重复投入 Compound，如此反复操作，对用户来说，是非常繁琐的，而且中间多次操作会消耗较多手续费。因此，直接提供杠杆交易服务的产品很受欢迎。</p>
<p>从用户需求层面来说，用户想要的就是做多或做空某种资产。比如，选定 ETH/USDT 交易对，开多的时候，就需要借入 USDT 并兑换成 ETH；开空的时候，则借入 ETH 来兑换 USDT。</p>
<p>当然，用户想要开仓，就需要先抵押资产作为<strong>保证金</strong>，这样才可借入资产。该逻辑其实和 Compound 的借贷逻辑一样，不同点在于，Compound 属于超额抵押借贷，存入价值 100 美刀的资产，最多只可借出 75 美刀的资产；但杠杆交易则可以借出多倍的资产，比如开 3 倍杠杆时，100 美刀的抵押资产，可以借出 300 美刀的资产来开仓。</p>
<p>这时，大部分人会想到的一个问题就是：抵押 100 美刀，借出 300 美刀，那多出的 200 美刀从哪来呢？这个问题的本质其实是：<strong>资金池里的资产从哪来？</strong></p>
<p>Compound 的资金池只有一种流入途径，那就是用户的存款。但杠杆交易的资金池，其实有两种流入途径，一是用户的存款，二是<strong>开仓后兑换所得的资产</strong>。<strong>第二种途径很重要，这是维持资金池流动性很关键的一点。</strong> 比如，当用户抵押了 100 美刀的 ETH，开仓时借出了 300 美刀的 USDT，兑换回来了 300 美刀的 ETH，这 300 美刀的 ETH 又流回到资金池里去，因此，资金池的总价值其实没有变化，只是同价值的 A 资产变成了 B 资产。如果兑换后的资产不流回资金池，那资金池很容易就会失衡，导致资金池的流动性不足，甚至枯竭。</p>
<p>多空平衡的情况下，资金池的流动性也会保持平衡。但是，如果出现极端情况，比如，多方远超于空方的时候，就要考虑是否会出现某一资金池枯竭的风险。多方抵押了 ETH，借出了 USDT，兑换回 ETH，随着多方的力量越来越强，那么 ETH 的资金池会越来越多，但 USDT 的资金池则越来越少，那 USDT 的资金池是否就会面临枯竭的风险呢？这种问题，其实在 Compound 中也同样存在，而 Compound 的机制中，<strong>降低这种风险的关键点在于利率模型，即资金使用率超过拐点后的利率会非常高，借款利率高涨就会使得用户借款的意愿减低，而存款利率高涨就会促进用户多存款，从而可以让资金池的供需关系又回到一个平衡的位置。</strong></p>
<p>对用户来说，杠杆交易的风险，和中心化的一样，就是<strong>存在爆仓的风险</strong>。抵押资产的价格变化、借款资产的价格变化、兑换资产的价格变化，以及借款利息的不断增长，都有可能导致爆仓。</p>
<p>借出的资产+利息称为<strong>债务</strong>，兑换回来的资产称为<strong>头寸</strong>，那对于每个持仓单，盈亏的计算公式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">盈亏 &#x3D; 头寸价值 - 债务价值</span><br></pre></td></tr></table></figure>
<p>盈亏为正时，表示盈利，那就不会有爆仓的风险。但是，盈亏为负时，就表示亏损了，一旦亏损率（亏损/保证金价值）超过某个阈值时（比如 80%），就需要强制平仓了，即是爆仓，也称为清算。为了避免爆仓，用户可以通过还款降低债务，或追加保证金。</p>
<p>如果用户自己想要止盈或止损了，就可以自己手动平仓了，平仓的逻辑也比较简单，将头寸资产再兑换回所借资产，接着还掉债务。如果兑换回来的资产不足以还债的话，那可能需要用部分抵押资产来兑换成所借资产并还债。</p>
<h2 id="杠杆挖矿"><a href="#杠杆挖矿" class="headerlink" title="杠杆挖矿"></a>杠杆挖矿</h2><p>自从 2020 年 6月 Compound 开启<strong>流动性挖矿</strong>（Yield Farming）以来，这一产业就迅速风靡，很多玩家都当起「农民」，通过为各种 DeFi 产品提供流动性来获得收益，收益一般为治理代币或交易费，或两者都有。比如，在 Compound 存款和借款都能挖到其治理代币 <strong>COMP</strong>；在 Uniswap 投入流动性得到 <strong>LP Token</strong> 可挖矿手续费；在 Uniswap 质押 <strong>LP Token</strong> 能挖到 <strong>UNI</strong> 代币和手续费。LP Token 本质上就类似于 cToken，不同交易对池子有不同的 LP Token。</p>
<p>杠杆挖矿则是将用户本金加杠杆，达到放大本金的效果，从而为用户提高挖矿的效率。目前大部分杠杆挖矿产品主要都是投入到如 Uniswap、SushiSwap、PancakeSwap 等 DEX 平台进行挖矿。</p>
<p>以 <strong>Alpha Homora</strong> 为例，矿池可分为两大类，一类称为 <strong>liquidity providing pools</strong>，另一类称为 <strong>yield farming pools</strong>。 <strong>liquidity providing pools</strong> 只是投入流动性到 DEX 平台得到 LP Token，从而赚取 DEX 平台的手续费和 Alpha 代币；而 <strong>yield farming pools</strong> 则会将 LP Token 质押到 DEX 平台，从而，除了赚取 DEX 平台的手续费和 Alpha 代币，还能赚到 DEX 的平台代币。两者的主要区别就在于是否将 LP Token 进行质押。</p>
<p>而用户要参与杠杆挖矿，首先选定要参与的一个池子，比如选定 <strong>Uniswap 的 UNI/ETH</strong> 池子。之后，用户需要投入本金，本金可以是 <strong>UNI、ETH</strong> 或这个交易对的 <strong>LP Token</strong>，可以投入这三种 Token 中的一种或多种。接着，用户就可以选定杠杆倍数和想要借的币种和数量，本金和杠杆倍数决定了最多可以借多少，借款币种可以是 UNI 和 ETH 中的一种或两种，一般只借一种。最后，用户再次确定各种数据，没问题就可以提交开仓了。开仓时，智能合约就会根据 Uniswap 上该池子的兑换率自动将部分资产兑换成另一种，让两种资产的数量能满足添加流动性的匹配要求，然后就投入到 Uniswap UNI/ETH 的资金池里，得到该池子的 LP Token。如果用户选择的是 <strong>liquidity providing pool</strong>，那流程到此就算完成了；如果用户选择的是 <strong>yield farming pool</strong>，那还会自动将 LP Token 质押到 Uniswap。</p>
<p>其他杠杆挖矿产品的逻辑也是大同小异，较大的不同在于其他杠杆挖矿产品大多只有 <strong>yield farming pools</strong>，并没有 <strong>liquidity providing pools</strong>。</p>
<p>那么，杠杆挖矿的风险又如何呢？</p>
<p>首先，在没杠杆的情况下，用户往 AMM 模式的 DEX 提供流动性时，参与挖矿的两个币种一旦出现汇率变化，就会产生<strong>无常损失</strong>（Impermanent loss，也称“非永久性损失”），价格波动越大，无常损失越大；而加了杠杆之后，放大了本金，也同样放大了无常损失。通常，无常损失需要靠手续费分成和质押 LP Token 的收益所得来填补。所以，用户平仓时，如果已经赚取的收益不能覆盖无常损失，那用户其实就是亏损的。当然，这还没算上借贷的利息。</p>
<p>另外，用户进行杠杆挖矿，还存在被清算的风险。借贷资产+利息就是债务，LP Token 的价值就是头寸，当债务比率（债务/头寸）达到清算线时，就会进行清算。为了避免清算，用户可以通过还款降低债务，或追加 LP Token 增加头寸。</p>
<p>杠杆挖矿最大的风险应该是<strong>资金池枯竭</strong>的风险，因为用户投入的本金和借贷的资产全都流入到 DEX 平台了，只有等到平仓后资产才会重新流回资金池。那么，如果没有足够的存款支撑，就难以维系下去。因此，需要大力吸引用户来存款，利率会远比 Compound、Aave 等借贷平台高得多，且通常采用三级利率模型，才可以较好地均衡资金池的资金使用率。比如，Alpaca（羊驼）的利率模型如下：</p>
<ul>
<li>资金使用率 0% - 50% 时，利率 = 0.4 × 资金使用率</li>
<li>资金使用率 50% - 90% 时，利率 = 20%（恒定）</li>
<li>资金使用率 90% - 100% 时，利率 = 13 × 资金使用率 - 11.5</li>
</ul>
<h2 id="操纵预言机攻击"><a href="#操纵预言机攻击" class="headerlink" title="操纵预言机攻击"></a>操纵预言机攻击</h2><p><strong>操控预言机所依赖的信息源进行短时间的价格操纵以达成误导链上价格是典型的预言机攻击，其本质是对预言机进行操控，造成内外价格差并利用闪电贷等新型金融工具从中套利。</strong></p>
<p><strong>Compound</strong> 曾在 2020 年 11 月 26 日遭受过价格预言机操纵攻击，导致价值高达八千多万美元的加密资产被系统强制清算。</p>
<p>因为 Compound 使用的是自己设计研发的预言机系统 <a href="https://compound.finance/prices" target="_blank" rel="noopener">Open Price Feed</a>，且使用的价格数据只依赖 <em>Coinbase</em> 这个中心化的交易所来提供。而当日下午，Coinbase 交易所稳定币 DAI 价格出现剧烈波动，一度暴涨超 30% 至 1.34 美元，后又快速回落。这一剧烈波动，就让很多借贷了 DAI 的用户资产触发了清算。</p>
<p>事实上，除了 Compound，Harvest Finance、Value DeFi、Cheese Bank、Origin Protocol 等都先后遭到类似预言机的攻击，MakerDAO 和 Aave 历史上也都因此发生过大规模清算。</p>
<p>针对此类攻击，安全建议如下：</p>
<ol>
<li>接入 Chainlink 等完善的第三方价格预言机对所有代币价格提供实时价格数据</li>
<li>在智能合约内部建立细致的价格监控程序，对任何可能产生巨大波动的交易进行管制或者阻止</li>
</ol>
<p>目前第三方价格预言机主要有：<strong>Chainlink、NEST、Band、DOS、Tellor、MakerDao</strong> 等。其中，龙头当属 Chainlink 了。Chainlink 使用<strong>链上聚合模式</strong>，节点将数据提交到链上合约，在合约内进行数据聚合，获得最终数据。</p>
<p>另外，随着 DEX 的发展，直接使用 DEX 的链上价格做为预言机也是一个很有潜力的方向，这需要 DEX 具有足够的深度，能够抵抗价格操纵，或者对价格进行加权等操作，来规避价格操纵攻击。这块目前应用最广泛的就是 <a href="https://uniswap.org/docs/v2/core-concepts/oracles/" target="_blank" rel="noopener">Uniswap TWAP</a>（Time-Weighted Average Price），即<strong>时间加权平均价格</strong>，可通过查看官方文档了解其机制：</p>
<ul>
<li><a href="https://uniswap.org/docs/v2/core-concepts/oracles/" target="_blank" rel="noopener">https://uniswap.org/docs/v2/core-concepts/oracles/</a></li>
</ul>
<p>如果还需要再进一步提高安全性，可以选择多个预言机进行加权平均计算，推荐 3 家第三方预言机 + 3 家 DEX 组合，比如选择 <strong>Chainlink、NEST、Band、Uniswap、SushiSwap、Bancor</strong>，每家可设置不同的权重值，计算时，获取到六家价格后，去掉最高价和最低价，剩下的再进行加权平均计算作为最后的实际价格。另外，在同个区块内，也无需每次交易都计算出实时价格，只要计算出一个合理价格后，整个区块内的交易都可直接使用该价格，这样，利用闪电贷操纵价格的手段也造不成威胁了。</p>
<h2 id="EIP712"><a href="#EIP712" class="headerlink" title="EIP712"></a>EIP712</h2><h4 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h4><p>这个EIP旨在提高链下消息签名对链上的可用性。我们可以看到，因为节省gas以及减少链上交易的原因，采用链下消息签名的需求日益增长。现在已经被签名的消息，展示给用户的是一串难以理解的16进制的字符串，附带一些组成这个消息的项目的上下文。</p>
<p><a href="https://eips.ethereum.org/EIPS/eip-712" target="_blank" rel="noopener">EIP-712: Typed structured data hashing and signing (ethereum.org)</a></p>
<p>在使用EIP712之前的签名信息：</p>
<p><img src="EIP712_before.png" alt=""></p>
<p>在使用EIP712之后的签名信息：</p>
<p><img src="EIP712_after.png" alt=""></p>
<h4 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h4><p>下面我们以一个拍卖场景为例，看看如何在产品中把 EIP712 用起来。</p>
<h5 id="定义数据结构"><a href="#定义数据结构" class="headerlink" title="定义数据结构"></a>定义数据结构</h5><p>首先，用 JSON 格式列出用户所要签名的数据。 比如作为一个拍卖应用，需要签名的就是下面的投标数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    amount: <span class="number">100</span>, </span><br><span class="line">    token: “<span class="number">0</span>x….”,</span><br><span class="line">    id: <span class="number">15</span>,</span><br><span class="line">    bidder: &#123;</span><br><span class="line">        userId: <span class="number">323</span>,</span><br><span class="line">        wallet: “<span class="number">0</span>x….”</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们可以从上面的代码片段中提炼出两个数据结构: 竞标 Bid，它包括以 <a href="https://learnblockchain.cn/2018/01/12/create_token/" target="_blank" rel="noopener">ERC20</a> 代币资产和拍卖 id 确定的出价金额，以及身份 Identity，它指定了用户 id 和 用户钱包地址。<br>下一步，将 Bid 和 Identity 定义为结构体，就可以写出下面的 solidity 合约代码了。 可以通过 EIP712 协议草案查看 EIP712 所支持的完整数据类型列表，比如地址、 bytes32、 uint256等。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Bid: &#123;</span><br><span class="line">    amount: uint256, </span><br><span class="line">    bidder: Identity</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">Identity: &#123;</span><br><span class="line">    userId: uint256,</span><br><span class="line">    wallet: address</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="设计域分隔符"><a href="#设计域分隔符" class="headerlink" title="设计域分隔符"></a>设计域分隔符</h5><p>主要防止一个 DApp 的签名还能在另一个 DApp 中工作，从而导致签名冲突。拿拍卖为例子的话，一个拍卖应用里的投标请求竟然在另外一个拍卖应用里也能执行成功，可能会就导致不必要的损失。</p>
<p>具体来说，域分隔符就是下面这样的结构和数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name: <span class="string">"Auction dApp"</span>, <span class="comment">// DApp 的名字</span></span><br><span class="line">    version: <span class="string">"2"</span>, <span class="comment">// DApp 的版本</span></span><br><span class="line">    chainId: <span class="string">"1"</span>, <span class="comment">// [EIP-155] 定义的 chainId</span></span><br><span class="line">    verifyingContract: <span class="string">"0x1c56346..."</span>, <span class="comment">// 验签合约地址</span></span><br><span class="line">    salt: <span class="string">"0x43efba6b4..."</span> <span class="comment">// 硬编码到合约和 DApp 中的一个随机数值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用签名实现委托"><a href="#使用签名实现委托" class="headerlink" title="使用签名实现委托"></a>使用签名实现委托</h4><p>按照<a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-712.md" target="_blank" rel="noopener">EIP-712</a> 规范定义的结构化数据签名方式，<a href="https://etherscan.io/address/0xc00e94cb662c3520282e6f5717214004a7f26888" target="_blank" rel="noopener">COMP代币</a>持有者可以委托给任何一个以太坊地址。任何用户只要有已签名的委托交易，都可以调用COMP智能合约中<strong>delegateBySig</strong> <a href="https://compound.finance/docs/governance#delegate-by-signature" target="_blank" rel="noopener">函数</a></p>
<p>这种方式的使用场景可能是，一个委托者希望联合其他COMP持有者将他们的投票委托给被委托人，并希望以非常低的成本来完成这项工作。</p>
<p>被委托者可以创建一个网页，让用户通过Metamask和私钥完成<strong>delegateBySig</strong> 交易，这样被委托者就能收集到签名信息。之后，被委托者可以将签名信息打包，批量一次写入到以太坊中，再执行<strong>delegateBySig</strong>函数就可以正式的收集到用户的投票权利。</p>
<h4 id="通过签名投票"><a href="#通过签名投票" class="headerlink" title="通过签名投票"></a>通过签名投票</h4><p><strong>delegateBySig</strong>一样，用户也可以委托第三方给 <a href="https://compound.finance/governance/proposals" target="_blank" rel="noopener">Compound治理提案</a>投票。任何用户只要有已签名的委投票交易，都可以调用智能合约中<strong>castVoteBySig</strong> <a href="https://compound.finance/docs/governance#cast-vote-by-signature" target="_blank" rel="noopener">函数</a></p>
<p>第三方提交用户签名交易和<strong>delegateBySig</strong>的情况是一样的，但是投票权利仅限于一个提案，并非无限制的提案。在第三方正式将投票交易发送到以太坊之前，原有的用户依然保留自主投票的权利。</p>
<h4 id="重放攻击注意点"><a href="#重放攻击注意点" class="headerlink" title="重放攻击注意点"></a>重放攻击注意点</h4><p>这个标准只是关于对消息签名和验证签名。在很多实际应用中，已签名的消息被用来授权一个动作，例如token交换。使用者需要确保当应用程序看到两笔一模一样的已签名消息时依然可以做出正确的行为，这一点十分重要。举个例子，重复的消息需要被拒绝，或者授权的行为应当是幂等的（注：一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同）。至于这是如何实现的，要视特定应用而定，并且超出了本标准的范围。</p>
<p>有关交易重放，我正打算整理一下写一篇文章</p>

                
                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/compound-government/" data-toggle="tooltip" data-placement="top" title="Compound系列（2）">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- tip start -->
                
                <div class="comment_notes_blank"></div>
                <div class="visitor_notice">
                    <img 
                        src="/img/notice.png" 
                        alt="notice"
                        title="notice"/>
                    <p class="notice">
                        true
                    </p>
                </div>
                

                
                <div class="comment_notes">
                    <p>
                        This is copyright.
                    </p>
                </div>
                
                <!-- tip end -->

                <!-- Music start-->
                
                
<link rel="stylesheet" href="../css/music-player/fonts/iconfont.css">


<link rel="stylesheet" href="../css/music-player/css/reset.css">


<link rel="stylesheet" href="../css/music-player/css/player.css">


<div class="music-player">
    <audio class="music-player__audio" ></audio>
    <div class="music-player__main">
        <div class="music-player__blur"></div>
        <div class="music-player__disc">
            <div class="music-player__image">
                <img width="100%" src="" alt="">
            </div>
            <div class="music-player__pointer"><img width="100%" src="/img/cd_tou.png" alt=""></div>
        </div>
        <div class="music-player__controls">
            <div class="music__info">
                <h3 class="music__info--title">...</h3>
                <p class="music__info--singer">...</p>
            </div>
            <div class="player-control">
                <div class="player-control__content">
                    <div class="player-control__btns">
                        <div class="player-control__btn player-control__btn--prev"><i class="iconfont icon-prev"></i></div>
                        <div class="player-control__btn player-control__btn--play"><i class="iconfont icon-play"></i></div>
                        <div class="player-control__btn player-control__btn--next"><i class="iconfont icon-next"></i></div>
                        <div class="player-control__btn player-control__btn--mode"><i class="iconfont icon-loop"></i></div>
                    </div>
                    <div class="player-control__volume">
                        <div class="control__volume--icon player-control__btn"><i class="iconfont icon-volume"></i></div>
                        <div class="control__volume--progress player_progress"></div>
                    </div>
                </div>
                <div class="player-control__content">
                    <div class="player__song--progress player_progress"></div>
                    <div class="player__song--timeProgess nowTime">00:00</div>
                    <div class="player__song--timeProgess totalTime">00:00</div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="../js/music-player/utill.js"></script>


<script src="../js/music-player/jquery.min.js"></script>

<!-- netease; qqkg -->
<!--
<script src="../js/music-player/player.js?library=config.music.library.js"></script>
-->
<script src="../../../../js/music-player/player.js?library=netease&music=https://kg.qq.com/node/play?s=7deFpz7Z26Jmv7di&g_f=share_html"></script>
                
                <!-- Music end -->

                <!-- Sharing -->
                
                <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                <!--  css & js -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!-- Sharing -->

                <!-- gitment start -->
                
                <!-- gitment end -->

                <!-- 来必力City版安装代码 -->
                
                <!-- City版安装代码已完成 -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      
        <aside id="sidebar">
          <div id="toc" class="toc-article">
          <strong class="toc-title">Contents</strong>
          
            
              <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Compound系列（3）-More"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Compound系列（3） More</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#杠杆交易"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">杠杆交易</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#杠杆挖矿"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">杠杆挖矿</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#操纵预言机攻击"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">操纵预言机攻击</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#EIP712"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">EIP712</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#摘要"><span class="toc-nav-number">1.4.0.1.</span> <span class="toc-nav-text">摘要</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#实现方法"><span class="toc-nav-number">1.4.0.2.</span> <span class="toc-nav-text">实现方法</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#定义数据结构"><span class="toc-nav-number">1.4.0.2.1.</span> <span class="toc-nav-text">定义数据结构</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#设计域分隔符"><span class="toc-nav-number">1.4.0.2.2.</span> <span class="toc-nav-text">设计域分隔符</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#使用签名实现委托"><span class="toc-nav-number">1.4.0.3.</span> <span class="toc-nav-text">使用签名实现委托</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#通过签名投票"><span class="toc-nav-number">1.4.0.4.</span> <span class="toc-nav-text">通过签名投票</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#重放攻击注意点"><span class="toc-nav-number">1.4.0.5.</span> <span class="toc-nav-text">重放攻击注意点</span></a></li></ol></li></ol></li></ol></li></ol>
            
          
          </div>
        </aside>
      
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Coumpound" title="Coumpound">Coumpound</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>


<style  type="text/css">
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">

                
                    <li>
                        <a target="_blank"  href="https://github.com/ThomasXu-blockchain">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Thomas_Xu 2022 
                    <br>
                    Powered by 
                    <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener">
                        <i>hexo-theme-snail</i>
                    </a> | 
                    <iframe name="star" style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0"
                        width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=dusign&repo=hexo-theme-snail&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>

</footer>

<!-- jQuery -->

<script src="../js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="../js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="../js/hux-blog.min.js"></script>


<!-- Search -->

<script src="../js/search.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://thomasxu-blockchain.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Search -->

    <script type="text/javascript">      
        var search_path = "search.xml";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
    var path = "/" + search_path;
    searchFunc(path, 'local-search-input', 'local-search-result');
    </script>


<!-- busuanzi -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>

    
        <!-- background effects line -->
        

        
            <script type="text/javascript" src="/js/mouse-click.js" content='[&quot;🍰&quot;,&quot;当大潮褪去，才知道谁在裸泳&quot;,&quot;🍭&quot;]' color='[&quot;rgb(121,93,179)&quot; ,&quot;rgb(76,180,231)&quot; ,&quot;rgb(184,90,154)&quot;]'></script>
        

        <!-- background effects end -->
    

    <!--<script size="50" alpha='0.3' zIndex="-999" src="/js/ribbonStatic.js"></script>-->
    
        <script src="/js/ribbonDynamic.js"></script>
    
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
